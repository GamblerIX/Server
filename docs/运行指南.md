# 鸣潮服务端运行指南

> 本指南将帮助您完成鸣潮服务端的完整配置和运行。

> 2.7的客户端补丁上游源码出现问题，频繁转发不存在服务的10009端口。静待上游修复，在此期间暂时不要游玩2.7。

> 假设您准备在`{PATH}\Server`文件夹下运行项目。

## 环境配置

### 第一步：下载并安装Git

下载地址：https://github.com/git-for-windows/git/releases/download/v2.50.1.windows.1/Git-2.50.1-64-bit.exe

- 安装过程中一直点击Next，直到安装完成。

### 第二步：克隆项目

1. 打开 PowerShell（管理员）

2. 创建文件夹并克隆项目
   ```PowerShell
   New-Item -Path "{PATH}\" -ItemType Directory -Force
   cd "{PATH}\"
   git clone https://github.com/GamblerIX/Server.git
   ```

  - 对于中国大陆用户，请执行以下代码：
    ```PowerShell
    New-Item -Path "{PATH}\" -ItemType Directory -Force
    cd "{PATH}\"
    git clone https://gitee.com/GamblerIX/Server.git
    ```

3. 设置文件夹权限
   ```PowerShell
   icacls "{PATH}\" /grant Users:F /T
   ```

### 第三步：安装PostgreSQL数据库

下载地址：https://get.enterprisedb.com/postgresql/postgresql-17.5-3-windows-x64.exe

> 安装时根据提示设置 postgres 用户密码：`Aa123456`

#### 创建数据库与用户

以 PowerShell 运行：
```PowerShell
Set-Location "C:\Program Files\PostgreSQL\17\bin"
.\psql -U postgres -h 127.0.0.1 -p 5432
```

> 输入密码：`Aa123456`

> 继续输入以下SQL命令：
```sql
CREATE DATABASE users;
CREATE USER users WITH PASSWORD 'password';
\c users
GRANT CREATE, USAGE ON SCHEMA public TO users;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO users;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON TABLES TO users;
```
> 若没有报错则关闭PowerShell。

### 第四步：安装Python

下载地址：https://www.python.org/ftp/python/3.13.7/python-3.13.7-amd64.exe

- 安装时务必勾选「Add to PATH」选项

### ✅ 环境验证

运行以下命令验证环境：
```PowerShell
python --version
git --version
```

确保输出显示正确的版本信息。

## 💻 客户端配置

### 💾 下载客户端

1. **客户端下载地址**：
   - 主要下载源：<https://www.123865.com/s/87lLTd-nUt3A?pwd=r1nx>
   - 备用下载源：https://onedrive.060810.xyz/s/7Xfl
   - 备用下载源：https://gofile.io/d/32LUct
   - 备用下载源：https://transfer.it/t/kWsuycphCDqa

   > 声明：客户端使用123云盘分享没有任何牟利目的。

2. **推荐下载方法**：
   1. **PC登录直接下载**（需要会员）
   2. **手机登录下载传到PC端**（不限速但麻烦）
   3. **使用脚本下载**：
      - PC端浏览器安装篡改猴插件
      - 访问脚本链接：<https://scriptcat.org/scripts/code/2385/123%20%E4%BA%91%E7%9B%98%E4%BC%9A%E5%91%98%E9%9D%92%E6%98%A5%E7%89%88.user.js>
      - 选择安装脚本，然后登陆下载（不限速但略微麻烦）
   4. **通过备用源下载**

3. **客户端安装**：
   - 解压下载的压缩包到`{PATH}\Client`文件夹
   - 确保`Wuthering Waves.exe`在`{PATH}\Client`文件夹内

4. **应用客户端补丁**：
   ```PowerShell
   cd "{PATH}\Server"
   python wuwa_server.py --patch --version {x.y}
   ```
   > 将{x.y}替换为您要游玩的版本号，例如：`python wuwa_server.py --patch --version 2.7`

## 🚀 服务端配置

### 下载服务端发行版

执行以下命令下载指定版本的服务端：

```PowerShell
cd "{PATH}\Server"
python wuwa_server.py --ddsr --version {x.y}
```

> 将{x.y}替换为您要下载的版本号，例如：`python wuwa_server.py --ddsr --version 2.7`

### 安装Python依赖

```PowerShell
cd "{PATH}\Server"
pip install -r requirements.txt
```

## 🎮 启动游戏

### 一键启动（推荐）

启动服务端和客户端：
```PowerShell
cd "{PATH}\Server"
python wuwa_server.py --run --all
```

### 分步启动

1. **仅启动服务端**：
   ```PowerShell
   python wuwa_server.py --run --serveronly
   ```

2. **仅启动客户端**：
   ```PowerShell
   python wuwa_server.py --run --clientonly
   ```

### 检查运行状态

```PowerShell
python wuwa_server.py --status --all
```

### 停止服务端

```PowerShell
python wuwa_server.py --stop
```

## ⚙️ 高级配置

### 🗄️ 数据库配置

默认数据库配置：
```
host = "127.0.0.1:5432"
user_name = "users"
password = "password"
db_name = "users"
```

### 🌐 服务端口配置

| 服务 | 端口 | 描述 |
|------|------|------|
| configserver | 10001 | 配置服务器 |
| loginserver | 5500 | 登录服务器 |
| gateway | 10003 | 网关服务器 |
| kcpport | 7777 | KCP传输端口 |
| gameserver | 10004 | 游戏服务器 |
| hotpatch | 10002 | 热更新服务器 |

## 🔧 完整命令参考

### 基础参数（必须且仅选一个）：

```
  --run         启动服务端
  --patch       应用补丁
  --status      查看状态
  --stop        停止服务端
  --check       环境检查
  --ddsr        下载服务端发行版
```

### 可叠加参数：

```
  --serveronly  仅服务端
  --clientonly  仅客户端
  --all         全部
  --version     指定版本 (格式: x.y)
```

### 参数叠加规则：

```
  --run:
    默认: --serveronly
    可叠加: --serveronly, --clientonly, --all

  --patch:
    必须叠加: --version x.y
    不可叠加其他参数

  --status:
    默认: --serveronly
    可叠加: --serveronly, --clientonly, --all
    不可叠加: --version

  --stop:
    默认: --serveronly
    仅可叠加: --serveronly

  --check:
    默认: --all
    可叠加: --serveronly, --clientonly, --all
    不可叠加: --version

  --ddsr:
    必须叠加: --version x.y
    不可叠加其他参数
```

### 🎯 使用示例

```PowerShell
  # 基础操作
  python wuwa_server.py --run                    # 启动服务端
  python wuwa_server.py --run --all              # 启动服务端和客户端
  python wuwa_server.py --run --clientonly       # 仅启动客户端
  
  # 补丁和版本管理
  python wuwa_server.py --patch --version 2.7    # 应用2.7版本补丁
  python wuwa_server.py --ddsr --version 2.7     # 下载2.7版本服务端
  
  # 状态和检查
  python wuwa_server.py --status --all           # 查看所有状态
  python wuwa_server.py --check --serveronly     # 检查服务端环境
  
  # 停止服务
  python wuwa_server.py --stop                   # 停止服务端
```

## ⚠️ 重要提醒

### 启动顺序
> **重要**：自2.7版本起，必须先启动服务端再启动客户端，否则客户端会提示远程配置获取失败。

### 权限要求
> 客户端必须以管理员身份启动，脚本会自动申请权限。

### 版本兼容性
> 不同版本的客户端需要对应版本的服务端和补丁，请确保版本一致。

### 端口占用
> 如遇到端口占用问题，请检查防火墙设置或关闭占用端口的其他程序。

### 环境检查
> 运行前建议先执行环境检查：`python wuwa_server.py --check --all`

## 🐛 故障排除

### 常见问题

1. **服务端启动失败**
   - 检查PostgreSQL是否正常运行
   - 验证数据库连接配置
   - 确认端口未被占用

2. **客户端连接失败**
   - 确保服务端已完全启动
   - 检查防火墙设置
   - 验证客户端补丁是否正确应用

3. **补丁应用失败**
   - 确认客户端路径正确
   - 检查文件权限
   - 验证版本号格式

4. **环境检查失败**
   - 重新安装Python和PostgreSQL
   - 检查PATH环境变量
   - 确认依赖包安装完整

### 获取帮助

如遇到其他问题，请：
1. 查看详细的错误日志
2. 在项目Issues中搜索相关问题
3. 提供完整的错误信息和系统环境

---

**📝 运行指南最后更新**: 2025年1月27日